<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feedback Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .stat-card.okay { background: linear-gradient(135deg, #feca57, #ff9ff3); }
        .stat-card.good { background: linear-gradient(135deg, #48cae4, #023e8a); }
        .stat-card.amazing { background: linear-gradient(135deg, #06ffa5, #0d7377); }
        .stat-card.total { background: linear-gradient(135deg, #667eea, #764ba2); }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .btn.danger {
            background: #ff6b6b;
        }

        .btn.danger:hover {
            background: #ee5a52;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .rating-badge {
            padding: 5px 12px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .rating-bad { background: #ff6b6b; }
        .rating-okay { background: #feca57; }
        .rating-good { background: #48cae4; }
        .rating-amazing { background: #06ffa5; color: #333; }

        .no-data {
            text-align: center;
            padding: 50px;
            color: #666;
            font-size: 1.2rem;
        }

        .refresh-info {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: #1976d2;
        }

        @media (max-width: 768px) {
            .controls {
                justify-content: center;
            }
           
            .data-table {
                font-size: 0.9rem;
            }
           
            .data-table th,
            .data-table td {
                padding: 10px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <h1>üìä Feedback Dashboard</h1>
       
        <div class="refresh-info">
            <strong>üí° Tip:</strong> This page shows feedback data stored locally in your browser.
            Refresh this page to see new responses, or click "Refresh Data" below.
        </div>

        <div class="stats-grid" id="statsGrid">
            <!-- Stats will be populated by JavaScript -->
        </div>

        <div class="controls">
            <button class="btn" onclick="refreshData()">üîÑ Refresh Data</button>
            <button class="btn" onclick="exportData()">üì• Export CSV</button>
            <button class="btn" onclick="viewRawData()">üîç View Raw Data</button>
            <button class="btn danger" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
        </div>

        <div id="dataTableContainer">
            <!-- Table will be populated by JavaScript -->
        </div>
    </div>

    <script>
        // Enhanced Admin Dashboard with Server Integration
        const AdminDashboard = {
           
            async getAllFeedback() {
                try {
                    const response = await fetch('/api/feedback');
                    if (response.ok) {
                        const serverData = await response.json();
                        console.log('üìä Loaded', serverData.length, 'responses from server');
                        return serverData;
                    } else {
                        throw new Error('Server not available');
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Server unavailable, using local data:', error.message);
                    return this.getLocalFeedback();
                }
            },
           
            getLocalFeedback() {
                try {
                    return JSON.parse(localStorage.getItem('feedbackResponses') || '[]');
                } catch (error) {
                    console.error('Error retrieving local feedback:', error);
                    return [];
                }
            },
           
            async getStats() {
                try {
                    const response = await fetch('/api/feedback/stats');
                    if (response.ok) {
                        return await response.json();
                    } else {
                        throw new Error('Server not available');
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Server unavailable, calculating local stats');
                    return this.calculateLocalStats();
                }
            },
           
            calculateLocalStats() {
                const data = this.getLocalFeedback();
                const stats = {
                    total: data.length,
                    bad: data.filter(f => f.rating === 'bad').length,
                    okay: data.filter(f => f.rating === 'okay').length,
                    good: data.filter(f => f.rating === 'good').length,
                    amazing: data.filter(f => f.rating === 'amazing').length
                };
               
                stats.satisfaction = data.length > 0 ?
                    Math.round(((stats.good + stats.amazing) / data.length) * 100) : 0;
                   
                return stats;
            },
           
            async exportToCSV() {
                const data = await this.getAllFeedback();
                if (data.length === 0) {
                    alert('No feedback data to export!');
                    return;
                }
               
                const csvContent = [
                    ['Rating', 'Date & Time', 'Session ID', 'Server ID', 'User Agent'],
                    ...data.map(item => [
                        item.rating,
                        item.dateString || new Date(item.timestamp).toLocaleString(),
                        item.sessionId || '',
                        item.serverId || '',
                        (item.userAgent || '').substring(0, 50) + '...'
                    ])
                ].map(row => row.map(field => `"${field}"`).join(',')).join('\n');
               
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `feedback_data_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
            },
           
            async clearAll() {
                if (!confirm('Are you sure you want to delete all feedback data? This cannot be undone.')) {
                    return false;
                }
               
                try {
                    const response = await fetch('/api/feedback/clear', { method: 'DELETE' });
                    if (response.ok) {
                        console.log('‚úÖ Server data cleared');
                    }
                } catch (error) {
                    console.warn('Could not clear server data:', error);
                }
               
                // Also clear local storage
                localStorage.removeItem('feedbackResponses');
                localStorage.removeItem('feedbackData');
               
                return true;
            }
        };

        async function loadDashboard() {
            try {
                // Show loading state
                document.getElementById('statsGrid').innerHTML = '<div style="text-align: center; padding: 20px;">üìä Loading data...</div>';
               
                const stats = await AdminDashboard.getStats();
                const data = await AdminDashboard.getAllFeedback();
               
                // Update stats grid
                document.getElementById('statsGrid').innerHTML = `
                    <div class="stat-card total">
                        <div class="stat-number">${stats.total}</div>
                        <div class="stat-label">Total Responses</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.bad}</div>
                        <div class="stat-label">üòû Bad</div>
                    </div>
                    <div class="stat-card okay">
                        <div class="stat-number">${stats.okay}</div>
                        <div class="stat-label">üòê Okay</div>
                    </div>
                    <div class="stat-card good">
                        <div class="stat-number">${stats.good}</div>
                        <div class="stat-label">üòä Good</div>
                    </div>
                    <div class="stat-card amazing">
                        <div class="stat-number">${stats.amazing}</div>
                        <div class="stat-label">ü§© Amazing</div>
                    </div>
                    <div class="stat-card total">
                        <div class="stat-number">${stats.satisfaction}%</div>
                        <div class="stat-label">Satisfaction Rate</div>
                    </div>
                `;

                // Update data table
                const tableContainer = document.getElementById('dataTableContainer');
               
                if (data.length === 0) {
                    tableContainer.innerHTML = `
                        <div class="no-data">
                            <h3>No feedback data found</h3>
                            <p>Responses will appear here once users start submitting feedback.</p>
                            <p><strong>üîó Share this link:</strong> <a href="${window.location.origin}" target="_blank">${window.location.origin}</a></p>
                        </div>
                    `;
                } else {
                    // Sort by most recent first
                    const sortedData = data.sort((a, b) => {
                        const dateA = new Date(a.serverTimestamp || a.timestamp);
                        const dateB = new Date(b.serverTimestamp || b.timestamp);
                        return dateB - dateA;
                    });
                   
                    const tableHTML = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Rating</th>
                                    <th>Date & Time</th>
                                    <th>Session ID</th>
                                    <th>Source</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedData.map(response => `
                                    <tr>
                                        <td>
                                            <span class="rating-badge rating-${response.rating}">
                                                ${response.rating.toUpperCase()}
                                            </span>
                                        </td>
                                        <td>${response.dateString || new Date(response.timestamp).toLocaleString()}</td>
                                        <td><code>${response.sessionId || 'N/A'}</code></td>
                                        <td>${response.serverId ? 'üåê Server' : 'üíæ Local'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                    tableContainer.innerHTML = tableHTML;
                }
               
                // Update last refresh time
                const now = new Date().toLocaleTimeString();
                const refreshInfo = document.querySelector('.refresh-info');
                refreshInfo.innerHTML = `
                    <strong>üí° Status:</strong> ${data.some(d => d.serverId) ? 'üåê Connected to server' : 'üíæ Using local data only'}
                    | Last updated: ${now}
                    | <a href="${window.location.origin}" target="_blank">üîó Feedback Form</a>
                `;
               
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('statsGrid').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: red;">
                        ‚ùå Error loading data: ${error.message}
                    </div>
                `;
            }
        }

        async function refreshData() {
            await loadDashboard();
            alert('‚úÖ Data refreshed successfully!');
        }

        async function exportData() {
            await AdminDashboard.exportToCSV();
        }

        function viewRawData() {
            AdminDashboard.getAllFeedback().then(data => {
                const newWindow = window.open('', '_blank');
                newWindow.document.write(`
                    <html>
                        <head>
                            <title>Raw Feedback Data</title>
                            <style>
                                body { font-family: monospace; padding: 20px; background: #f5f5f5; }
                                pre { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                            </style>
                        </head>
                        <body>
                            <h2>Raw Feedback Data (JSON)</h2>
                            <p>Total records: ${data.length}</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </body>
                    </html>
                `);
            });
        }

        async function clearAllData() {
            if (await AdminDashboard.clearAll()) {
                loadDashboard();
                alert('üóëÔ∏è All data has been cleared successfully!');
            }
        }

        // Auto-refresh every 30 seconds
        setInterval(loadDashboard, 30000);

        // Load dashboard on page load
        document.addEventListener('DOMContentLoaded', loadDashboard);
       
        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'r':
                        e.preventDefault();
                        refreshData();
                        break;
                    case 'e':
                        e.preventDefault();
                        exportData();
                        break;
                }
            }
        });
    </script>
</body>
</html>


